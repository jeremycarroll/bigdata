#!/bin/bash

#
# Script brings up the bigdata services on a host.
#
# @todo use 'lockfile' rather than 'touch'?

# Setup the environment.
cd `dirname $0`
source ./bigdataenv

# Verify critical environment variables.
if [ -z "$lockFile" ]; then
	echo -n $"$0 : environment not setup."
	exit 1;
fi
if [ -z "$pidFile" ]; then
	echo -n $"$0 : environment not setup."
	exit 1;
fi
if [ -z "$LAS" ]; then
	echo -n $"$0 : environment not setup."
	exit 1;
fi
if [ -z "$JAVA_OPTS" ]; then
	echo -n $"$0 : environment not setup."
	exit 1;
fi
if [ -z "$BIGDATA_CONFIG" ]; then
	echo -n $"$0 : environment not setup."
	exit 1;
fi

#
# Create a local directory in which to execute the services and within
# which they will store their persistent state.
#
if [ ! -d "$LAS" ]; then
    echo $"`date` : `hostname` : creating data directory."
    mkdir "$LAS"
fi

# Clear out old pid (presumed stale)
rm -f "$pidFile"

# Touch the subsystem lock file.
touch "$lockFile"

# @TODO this command must be generated and then executed in order to
# have the Configuration file applied.
java ${JAVA_OPTS} \
	 com.bigdata.jini.start.ServicesManagerServer \
	 ${BIGDATA_CONFIG} ${BIGDATA_CONFIG_OVERRIDES} &

pid=$!

# Save the pid on a file.
echo $pid > "$pidFile"

echo $"`date` : `hostname` : running : pid=$pid"

exit 0
