/* Configuration file for the Zookeeper wrapper service;
 * where the wrapper service implementation is provided
 * in the Bigdata codebase, and belongs to the
 * com.bigdata.quorum namespace.
 */

import java.net.NetworkInterface;

import com.sun.jini.config.ConfigUtil;
import net.jini.constraint.BasicMethodConstraints;
import net.jini.core.constraint.ConnectionRelativeTime;
import net.jini.core.constraint.InvocationConstraints;
import net.jini.jeri.BasicILFactory;
import net.jini.jeri.BasicJeriExporter;
import net.jini.jeri.tcp.TcpServerEndpoint;
import net.jini.core.discovery.LookupLocator;
import net.jini.discovery.LookupDiscoveryManager;

import com.bigdata.util.config.NicUtil;
import com.bigdata.util.config.ConfigDeployUtil;

com.bigdata.quorum {

    private static exportIpAddr = 
        NicUtil.getIpAddress("default.nic", ConfigDeployUtil.getString("node.serviceNetwork"), false);
    private static exportPort = 
        Integer.parseInt( System.getProperty("exportPort", "0") );

    groupsToJoin = ConfigDeployUtil.getGroupsToDiscover();
    locatorsToJoin = ConfigDeployUtil.getLocatorsToDiscover();

    private static exporterTcpServerEndpoint = 
        TcpServerEndpoint.getInstance(exportIpAddr, exportPort);
    private static serverILFactory =
        new BasicILFactory(
            new BasicMethodConstraints(
                new InvocationConstraints(
                    new ConnectionRelativeTime(
                        ConfigDeployUtil.getLong(
                            "rmi.connectTimeout")),
                    null)),
            null);

    serverExporter = 
        new BasicJeriExporter
            (TcpServerEndpoint.getInstance(exportIpAddr,exportPort),
                                           serverILFactory,
                                           false,
                                           true);

    static discoveryManager = new LookupDiscoveryManager(groupsToJoin,
                                                         locatorsToJoin,
                                                         null,
                                                         this);
    // Where service state is persisted
    persistenceDirectory = 
        ConfigUtil.concat
            ( new String[] { System.getProperty("app.home", "${user.dir}"), 
                             "${/}var${/}state${/}quorumState" } );

    peerDiscoveryPeriod = 300000L;// wait 5 minutes for peer discovery

    // If standard zookeeper config is specified,
    // it will override jini config; for example,
    //zookeeperConfigFile =
    //    "${user.home}${/}tmp${/}zookeeper${/}conf${/}test-zookeeper-q3.cfg";
}

net.jini.discovery.LookupDiscovery {
    multicastRequestHost = com.bigdata.quorum.exportIpAddr;
    multicastInterfaces = new NetworkInterface[] {
        NicUtil.getNetworkInterface(com.bigdata.quorum.exportIpAddr)
    };
}

net.jini.lookup.ServiceDiscoveryManager {
    eventListenerExporter =
        new BasicJeriExporter
            (com.bigdata.quorum.exporterTcpServerEndpoint,
             com.bigdata.quorum.serverILFactory, false, false);
}
