<project name="bigdata-integration-lookup-starter" default="help" basedir=".">

    <target name="help">
        <echo level="error" message="This script must be run with either the 'start' or 'stop' targets" />
        <antcall target="dumpProps" />
    </target>

    <target name="dumpProps">
        <echo message="Application properties:" />
        <echo message="-----------------------" />
        <echoproperties prefix="integ." />
        <echo message="-----------------------" />
    </target>

    <target name="start">
        <echo message="Starting support services..." />
        
        <!-- Probably overkill, but here just in case the previous run
             failed to kill the leftover processes for some reason -->
        <antcall target="kill-leftover-processes" />
        <antcall target="dumpProps" />
        <antcall target="startHttpd" />
        <antcall target="startLookup" />
    </target>

    <target name="stop">
        <echo message="Stopping support services..." />
        <antcall target="dumpProps" />
        <antcall target="stopLookup" />
        <antcall target="stopHttpd" />
        <antcall target="kill-leftover-processes" />
    </target>

    <target name="startHttpd">
        <echo message="Starting class(http) service..." />
        <java jar="${integ.deploy.lib}/classserver.jar" fork="true" spawn="true">
            <arg value="-verbose" />
            <arg value="-stoppable" />
            <arg line="-port ${integ.test.codebase.port}" />
            <arg line="-dir  '${integ.test.codebase.dir}'" />
        </java>
    </target>

    <target name="stopHttpd">
        <echo message="Stopping class(http) service..." />
        <java jar="${integ.deploy.lib}/classserver.jar" fork="true" spawn="false" failonerror="true">
            <arg line="-port ${integ.test.codebase.port}" />
            <arg line="-dir  '${integ.test.codebase.dir}'" />
            <arg value="-stop" />
        </java>
    </target>

    <target name="startLookup">
        <echo message="Starting lookup service..." />
        <java jar="${integ.deploy.lib}/${integ.parent.artifactName}-lookupstarter.jar" fork="true" spawn="true">
            <sysproperty key="app.home" value="${integ.app.home}" />
            <sysproperty key="jini.lib" value="${integ.deploy.lib}" />
            <sysproperty key="jini.lib.dl" value="${integ.deploy.lib.dl}" />
            <sysproperty key="java.security.policy" value="${integ.java.security.policy}" />
            <sysproperty key="java.security.debug" value="off" />
            <sysproperty key="java.protocol.handler.pkgs" value="net.jini.url" />
            <sysproperty key="log4j.configuration" value="${integ.log4j.configuration}" />
            <sysproperty key="codebase.port" value="${integ.test.codebase.port}" />
            <sysproperty key="java.net.preferIPv4Stack" value="${integ.java.net.preferIPv4Stack}" />
            <sysproperty key="federation.name" value="${integ.federation.name}" />
            <sysproperty key="default.nic" value="${integ.default.nic}" />
        </java>
    </target>

    <target name="stopLookup">
        <echo message="Stopping lookup service..." />
        <java jar="${integ.deploy.lib}/${integ.parent.artifactName}-lookupstarter.jar" fork="true" spawn="false" failonerror="true">
            <sysproperty key="app.home" value="${integ.app.home}" />
            <sysproperty key="jini.lib" value="${integ.deploy.lib}" />
            <sysproperty key="jini.lib.dl" value="${integ.deploy.lib.dl}" />
            <sysproperty key="java.security.policy" value="${integ.java.security.policy}" />
            <sysproperty key="log4j.configuration" value="${integ.log4j.configuration}" />
            <sysproperty key="java.net.preferIPv4Stack" value="${integ.java.net.preferIPv4Stack}" />
            <sysproperty key="federation.name" value="${integ.federation.name}" />
            <sysproperty key="default.nic" value="${integ.default.nic}" />
            <arg value="-stop" />
        </java>
    </target>

    <!-- Some tests currently leave processes (e.g. QuorumPeerMain) hanging around after
         the tests have completed.  This task kills those processes (Unix-only). -->

    <target name="kill-leftover-processes">
        <echo message="Killing leftover processes" />
        <chmod file="${basedir}/kill_leftover_processes.sh" perm="777" verbose="true" />
        <exec spawn="false" resolveexecutable="true" executable="kill_leftover_processes.sh">   
        </exec>
    </target>

    <target name="clean-sparql-test-suite" description="delete the files unpacked by the Sesame SPARQL test suite.">
        <echo>"clearing: ${java.io.tmpdir}/sparql-*"</echo>
        <delete verbose="true">
            <dirset dir="${java.io.tmpdir}" includes="sparql-*" />
        </delete>
    </target>
</project>
